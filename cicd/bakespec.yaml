version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8

  pre_build:
    commands:
      - echo Logging into artifactory
      - docker login tr1-docker-remote.jfrog.io -u ${ARTIFACTORY_USERNAME} -p ${ARTIFACTORY_PASSWORD}

      - echo Installing pre-requisites.
      - pip3 install boto3 docker pyyaml  # Requirements for helper script

  build:
    commands:
      # Build image
      - echo "Building the Docker image..."
      - IMAGE_NAME=a206296-u6121086-dojo-repo  # FIXME From output `ECRName` in a206296-${u6121086}-ems-dojo-cicd-ecr-repository stack in deployment account
      - HASH=`date +%s`
      - docker build . --tag ${IMAGE_NAME}:latest

  post_build:
    commands:
      # This Python script tags and pushes the images to the ECRs in the accounts and regions in the environments in your deployspec.
      # It also modifies the deployspec to put the right image URL in the given path in your deployspec environents.
      - cd cicd
      - |-
        python3 bake_helper.py --image ${IMAGE_NAME} --tag ${HASH} --param-path DeployerParameters.Stack.Parameters.ContainerImageUri

artifacts:
  files:
    - "**/*"
