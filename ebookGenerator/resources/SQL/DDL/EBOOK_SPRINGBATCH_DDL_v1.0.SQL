/*
Created: 12/15/2011
Modified: 12/15/2011
Project: COBALT EBOOK BUILDER
Model: EBOOK_SPRINGBATCH
Company: Thomson Reuters
Author: Selvedin Alic
Version: 1.0
Database: Oracle 11g Release 1
*/

-- Create sequences section -------------------------------------------------

CREATE SEQUENCE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION_SEQ"
 INCREMENT BY 1
 NOMAXVALUE
 NOMINVALUE
 CACHE 20
/

CREATE SEQUENCE "EBOOK_SPRINGBATCH"."BATCH_JOB_SEQ"
 INCREMENT BY 1
 NOMAXVALUE
 NOMINVALUE
 CACHE 20
/

CREATE SEQUENCE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION_SEQ"
 INCREMENT BY 1
 NOMAXVALUE
 NOMINVALUE
 CACHE 20
/

-- Create tables section -------------------------------------------------

-- Table EBOOK_SPRINGBATCH.BATCH_JOB_EXECUTION

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION"(
  "JOB_EXECUTION_ID" Number,
  "VERSION" Number,
  "JOB_INSTANCE_ID" Number NOT NULL,
  "CREATE_TIME" Timestamp(6) NOT NULL,
  "START_TIME" Timestamp(6) DEFAULT NULL,
  "END_TIME" Timestamp(6) DEFAULT NULL,
  "STATUS" Varchar2(10 ),
  "EXIT_CODE" Varchar2(20 ),
  "EXIT_MESSAGE" Varchar2(2500 ),
  "LAST_UPDATED" Timestamp(6)
)
/

-- Add keys for table EBOOK_SPRINGBATCH.BATCH_JOB_EXECUTION

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION" ADD CONSTRAINT "PK_JOB_EXEC" PRIMARY KEY ("JOB_EXECUTION_ID")
/

-- Table EBOOK_SPRINGBATCH.BATCH_STEP_EXECUTION

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION"(
  "STEP_EXECUTION_ID" Number,
  "VERSION" Number NOT NULL,
  "STEP_NAME" Varchar2(100 ) NOT NULL,
  "JOB_EXECUTION_ID" Number NOT NULL,
  "START_TIME" Timestamp(6) NOT NULL,
  "END_TIME" Timestamp(6) DEFAULT NULL,
  "STATUS" Varchar2(10 ),
  "COMMIT_COUNT" Number,
  "READ_COUNT" Number,
  "FILTER_COUNT" Number,
  "WRITE_COUNT" Number,
  "READ_SKIP_COUNT" Number,
  "WRITE_SKIP_COUNT" Number,
  "PROCESS_SKIP_COUNT" Number,
  "ROLLBACK_COUNT" Number,
  "EXIT_CODE" Varchar2(20 ),
  "EXIT_MESSAGE" Varchar2(2500 ),
  "LAST_UPDATED" Timestamp(6)
)
/

-- Add keys for table EBOOK_SPRINGBATCH.BATCH_STEP_EXECUTION

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION" ADD CONSTRAINT "PK_STEP_EXEC" PRIMARY KEY ("STEP_EXECUTION_ID")
/

-- Table EBOOK_SPRINGBATCH.BATCH_STEP_EXECUTION_CONTEXT

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION_CONTEXT"(
  "STEP_EXECUTION_ID" Number,
  "SHORT_CONTEXT" Varchar2(2500 ) NOT NULL,
  "SERIALIZED_CONTEXT" Clob
)
/

-- Add keys for table EBOOK_SPRINGBATCH.BATCH_STEP_EXECUTION_CONTEXT

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION_CONTEXT" ADD CONSTRAINT "PK_STEP_EXEC_CONTEXT" PRIMARY KEY ("STEP_EXECUTION_ID")
/

-- Table EBOOK_SPRINGBATCH.BATCH_JOB_PARAMS

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_PARAMS"(
  "JOB_INSTANCE_ID" Number NOT NULL,
  "TYPE_CD" Varchar2(6 ) NOT NULL,
  "KEY_NAME" Varchar2(100 ) NOT NULL,
  "STRING_VAL" Varchar2(250 ),
  "DATE_VAL" Timestamp(6) DEFAULT NULL,
  "LONG_VAL" Number,
  "DOUBLE_VAL" Float
)
/

-- Table EBOOK_SPRINGBATCH.BATCH_JOB_INSTANCE

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_INSTANCE"(
  "JOB_INSTANCE_ID" Number,
  "VERSION" Number,
  "JOB_NAME" Varchar2(100 ) NOT NULL,
  "JOB_KEY" Varchar2(2500 )
)
/

-- Add keys for table EBOOK_SPRINGBATCH.BATCH_JOB_INSTANCE

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_INSTANCE" ADD CONSTRAINT "PK_JOB_INSTANCE" PRIMARY KEY ("JOB_INSTANCE_ID")
/

-- Table EBOOK_SPRINGBATCH.BATCH_JOB_EXECUTION_CONTEXT

CREATE TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION_CONTEXT"(
  "JOB_EXECUTION_ID" Number,
  "SHORT_CONTEXT" Varchar2(2500 ) NOT NULL,
  "SERIALIZED_CONTEXT" Clob
)
/

-- Add keys for table EBOOK_SPRINGBATCH.BATCH_JOB_EXECUTION_CONTEXT

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION_CONTEXT" ADD CONSTRAINT "PK_JOB_EXEC_CONTEXT" PRIMARY KEY ("JOB_EXECUTION_ID")
/

-- Create procedures section -------------------------------------------------

CREATE PROCEDURE "EBOOK_SPRINGBATCH"."GRANT_PRIVILEGES"
AS
 V_OWNER  VARCHAR2(30);
 SQL_STMT VARCHAR2(2000);

 CURSOR GET_TABLE_NAMES IS
    SELECT T.TABLE_NAME
    FROM USER_TABLES T;
 
  GET_TBL GET_TABLE_NAMES%ROWTYPE;
    
 CURSOR GET_OBJ_NAMES IS
    SELECT OBJ.OBJECT_NAME
    FROM USER_OBJECTS OBJ
    WHERE OBJ.OBJECT_TYPE = 'PROCEDURE' OR OBJ.OBJECT_TYPE = 'FUNCTION';
  
  GET_OBJ GET_OBJ_NAMES%ROWTYPE;
  
  CURSOR GET_SEQ_NAMES IS
     SELECT SEQUENCE_NAME 
     FROM USER_SEQUENCES;
     
  GET_SEQ GET_SEQ_NAMES%ROWTYPE;

BEGIN
    SELECT USERNAME
    INTO V_OWNER
    FROM USER_USERS;
    
    OPEN GET_TABLE_NAMES;
        LOOP
             FETCH GET_TABLE_NAMES INTO GET_TBL;
             EXIT WHEN GET_TABLE_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_READ';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
             SQL_STMT := 'GRANT SELECT, INSERT, DELETE, UPDATE ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_TABLE_NAMES;
    
    OPEN GET_OBJ_NAMES;
        LOOP
             FETCH GET_OBJ_NAMES INTO GET_OBJ;
             EXIT WHEN GET_OBJ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT EXECUTE ON  ' || V_OWNER || '.' || GET_OBJ.OBJECT_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_OBJ_NAMES;
    
    OPEN GET_SEQ_NAMES;
        LOOP
             FETCH GET_SEQ_NAMES INTO GET_SEQ;
             EXIT WHEN GET_SEQ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_SEQ.SEQUENCE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_SEQ_NAMES;

END GRANT_PRIVILEGES;
/

-- Create relationships section ------------------------------------------------- 

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION" ADD CONSTRAINT "JOB_EXECUTION_STEP_FK" FOREIGN KEY ("JOB_EXECUTION_ID") REFERENCES "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION" ("JOB_EXECUTION_ID")
/

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION_CONTEXT" ADD CONSTRAINT "STEP_EXEC_CTX_FK" FOREIGN KEY ("STEP_EXECUTION_ID") REFERENCES "EBOOK_SPRINGBATCH"."BATCH_STEP_EXECUTION" ("STEP_EXECUTION_ID")
/

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION" ADD CONSTRAINT "JOB_INSTANCE_EXECUTION_FK" FOREIGN KEY ("JOB_INSTANCE_ID") REFERENCES "EBOOK_SPRINGBATCH"."BATCH_JOB_INSTANCE" ("JOB_INSTANCE_ID")
/

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_PARAMS" ADD CONSTRAINT "JOB_INSTANCE_PARAMS_FK" FOREIGN KEY ("JOB_INSTANCE_ID") REFERENCES "EBOOK_SPRINGBATCH"."BATCH_JOB_INSTANCE" ("JOB_INSTANCE_ID")
/

ALTER TABLE "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION_CONTEXT" ADD CONSTRAINT "JOB_EXEC_CTX_FK" FOREIGN KEY ("JOB_EXECUTION_ID") REFERENCES "EBOOK_SPRINGBATCH"."BATCH_JOB_EXECUTION" ("JOB_EXECUTION_ID")
/



-- Grant permissions section -------------------------------------------------



EXEC EBOOK_SPRINGBATCH.GRANT_PRIVILEGES;
