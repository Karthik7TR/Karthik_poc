/*
Created: 1/23/2012
Modified: 1/26/2012
Project: COBALT_EBOOK_BUILDER
Model: EBOOK
Company: Thomson Reuters
Author: Selvedin Alic
Version: 1.1
Database: Oracle 10g
*/

-- Create tables section -------------------------------------------------

-- Table EBOOK.EBOOK_DEFINITION

CREATE TABLE "EBOOK"."EBOOK_DEFINITION"(
  "TITLE_ID" Varchar2(64 ) CONSTRAINT "SYS_C0017937" NOT NULL,
  "BOOK_NAME" Varchar2(1024 ) CONSTRAINT "SYS_C0017938" NOT NULL,
  "MAJOR_VERSION" Number CONSTRAINT "SYS_C0017955" NOT NULL,
  "MINOR_VERSION" Number CONSTRAINT "SYS_C0017956" NOT NULL,
  "COPYRIGHT" Varchar2(1024 ),
  "MATERIAL_ID" Varchar2(64 ),
  "AUTHOR_INFO" Varchar2(1024 ),
  "ROOT_TOC_GUID" Varchar2(64 ),
  "DOC_COLLECTION_NAME" Varchar2(64 ),
  "TOC_COLLECTION_NAME" Varchar2(64 ),
  "NORT_DOMAIN" Varchar2(64 ),
  "NORT_FILTER_VIEW" Varchar2(64 ),
  "CONTENT_TYPE" Varchar2(64 ),
  "COVER_IMAGE" Varchar2(256 ),
  "ISBN" Varchar2(64 ),
  "MATERIAL_ID_EMBEDDED" Varchar2(8 ),
  "CONTENT_SUBTYPE" Varchar2(64 )
)
/

-- Table EBOOK.XSLT_MAPPER

CREATE TABLE "EBOOK"."XSLT_MAPPER"(
  "COLLECTION" Varchar2(30 ),
  "DOC_TYPE" Varchar2(10 ),
  "CONTENT_TYPE" Varchar2(80 ),
  "XSLT" Varchar2(50 )
)
/

-- Table EBOOK.SCHEMA_VERSION

CREATE TABLE "EBOOK"."SCHEMA_VERSION"(
  "SCHEMA_VERSION" Number NOT NULL,
  "COMMENTS" Varchar2(4000 ) NOT NULL,
  "CHANGE_DATE" Timestamp(3) DEFAULT sysdate NOT NULL
)
/

INSERT INTO EBOOK.SCHEMA_VERSION (SCHEMA_VERSION, COMMENTS, CHANGE_DATE)
VALUES (1.0, 'Initial model created.', TO_DATE('01/23/2011', 'MM/DD/YYYY'));

INSERT INTO EBOOK.SCHEMA_VERSION (SCHEMA_VERSION, COMMENTS, CHANGE_DATE)
VALUES (1.1, 'Updated XSLT_MAPPER.XSLT from Varchar2(30) to Varchar2(50).', TO_DATE('01/26/2011', 'MM/DD/YYYY'));

-- Create procedures section -------------------------------------------------

CREATE PROCEDURE "EBOOK"."GRANT_PRIVILEGES"
AS
 V_OWNER  VARCHAR2(30);
 SQL_STMT VARCHAR2(2000);

 CURSOR GET_TABLE_NAMES IS
    SELECT T.TABLE_NAME
    FROM USER_TABLES T;
 
  GET_TBL GET_TABLE_NAMES%ROWTYPE;
    
 CURSOR GET_OBJ_NAMES IS
    SELECT OBJ.OBJECT_NAME
    FROM USER_OBJECTS OBJ
    WHERE OBJ.OBJECT_TYPE = 'PROCEDURE' OR OBJ.OBJECT_TYPE = 'FUNCTION';
  
  GET_OBJ GET_OBJ_NAMES%ROWTYPE;
  
  CURSOR GET_SEQ_NAMES IS
     SELECT SEQUENCE_NAME 
     FROM USER_SEQUENCES;
     
  GET_SEQ GET_SEQ_NAMES%ROWTYPE;

BEGIN
    SELECT USERNAME
    INTO V_OWNER
    FROM USER_USERS;
    
    OPEN GET_TABLE_NAMES;
        LOOP
             FETCH GET_TABLE_NAMES INTO GET_TBL;
             EXIT WHEN GET_TABLE_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_READ';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
             SQL_STMT := 'GRANT SELECT, INSERT, DELETE, UPDATE ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_TABLE_NAMES;
    
    OPEN GET_OBJ_NAMES;
        LOOP
             FETCH GET_OBJ_NAMES INTO GET_OBJ;
             EXIT WHEN GET_OBJ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT EXECUTE ON  ' || V_OWNER || '.' || GET_OBJ.OBJECT_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_OBJ_NAMES;
    
    OPEN GET_SEQ_NAMES;
        LOOP
             FETCH GET_SEQ_NAMES INTO GET_SEQ;
             EXIT WHEN GET_SEQ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_SEQ.SEQUENCE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_SEQ_NAMES;

END GRANT_PRIVILEGES;
/



-- Grant permissions section -------------------------------------------------



EXEC EBOOK.GRANT_PRIVILEGES;
