/*
Created: 12/21/2011
Modified: 12/21/2011
Project: COBALT_EBOOK_BUILDER
Model: EBOOK_AUTHORITY
Company: Thomson Reuters
Author: Selvedin Alic
Version: 1.0
Database: Oracle 10g
*/

-- Create tables section -------------------------------------------------

-- Table EBOOK_AUTHORITY.DOCUMENT_METADATA

CREATE TABLE "EBOOK_AUTHORITY"."DOCUMENT_METADATA"(
  "TITLE_ID" Varchar2(64 ) NOT NULL,
  "JOB_INSTANCE_ID" Number,
  "DOC_UUID" Varchar2(36 ) NOT NULL,
  "DOC_FAMILY_UUID" Varchar2(36 ) NOT NULL,
  "DOC_TYPE" Varchar2(10 ),
  "NORMALIZED_FIRSTLINE_CITE" Varchar2(100 ),
  "FIND_ORIG" Varchar2(80 ),
  "SERIAL_NUMBER" Number,
  "COLLECTION_NAME" Varchar2(36 ) NOT NULL,
  "LAST_UPDATED" Timestamp(6) NOT NULL
)
/

-- Add keys for table EBOOK_AUTHORITY.DOCUMENT_METADATA

ALTER TABLE "EBOOK_AUTHORITY"."DOCUMENT_METADATA" ADD CONSTRAINT "PK_DOC_META" PRIMARY KEY ("TITLE_ID","JOB_INSTANCE_ID","DOC_UUID")
/

-- Table EBOOK_AUTHORITY.SCHEMA_VERSION

CREATE TABLE "EBOOK_AUTHORITY"."SCHEMA_VERSION"(
  "SCHEMA_VERSION" Number NOT NULL,
  "COMMENTS" Varchar2(4000 ) NOT NULL,
  "CHANGE_DATE" Timestamp(3) DEFAULT sysdate NOT NULL
)
/

INSERT INTO EBOOK_AUTHORITY.SCHEMA_VERSION (SCHEMA_VERSION, COMMENTS, CHANGE_DATE)
VALUES (1.0, 'Initial model created.', TO_DATE('12/21/2011', 'MM/DD/YYYY'));

-- Create procedures section -------------------------------------------------

CREATE OR REPLACE PROCEDURE "EBOOK_AUTHORITY"."GRANT_PRIVILEGES"
AS
 V_OWNER  VARCHAR2(30);
 SQL_STMT VARCHAR2(2000);

 CURSOR GET_TABLE_NAMES IS
    SELECT T.TABLE_NAME
    FROM USER_TABLES T;
 
  GET_TBL GET_TABLE_NAMES%ROWTYPE;
    
 CURSOR GET_OBJ_NAMES IS
    SELECT OBJ.OBJECT_NAME
    FROM USER_OBJECTS OBJ
    WHERE OBJ.OBJECT_TYPE = 'PROCEDURE' OR OBJ.OBJECT_TYPE = 'FUNCTION';
  
  GET_OBJ GET_OBJ_NAMES%ROWTYPE;
  
  CURSOR GET_SEQ_NAMES IS
     SELECT SEQUENCE_NAME 
     FROM USER_SEQUENCES;
     
  GET_SEQ GET_SEQ_NAMES%ROWTYPE;

BEGIN
    SELECT USERNAME
    INTO V_OWNER
    FROM USER_USERS;
    
    OPEN GET_TABLE_NAMES;
        LOOP
             FETCH GET_TABLE_NAMES INTO GET_TBL;
             EXIT WHEN GET_TABLE_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_READ';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
             SQL_STMT := 'GRANT SELECT, INSERT, DELETE, UPDATE ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_TABLE_NAMES;
    
    OPEN GET_OBJ_NAMES;
        LOOP
             FETCH GET_OBJ_NAMES INTO GET_OBJ;
             EXIT WHEN GET_OBJ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT EXECUTE ON  ' || V_OWNER || '.' || GET_OBJ.OBJECT_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_OBJ_NAMES;
    
    OPEN GET_SEQ_NAMES;
        LOOP
             FETCH GET_SEQ_NAMES INTO GET_SEQ;
             EXIT WHEN GET_SEQ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_SEQ.SEQUENCE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_SEQ_NAMES;

END GRANT_PRIVILEGES;
/



-- Grant permissions section -------------------------------------------------



EXEC EBOOK_AUTHORITY.GRANT_PRIVILEGES;
