/*
Created: 4/2/2012
Modified: 4/2/2012
Project: COBALT_EBOOK_BUILDER
Model: EBOOK_CONFIG
Company: THOMSON REUTERS
Author: SELVEDIN ALIC
Version: 1.0
Database: Oracle 10g
*/



-- Create tables section -------------------------------------------------

-- Table JOB_STARTUP_THROTTLE

CREATE TABLE "JOB_STARTUP_THROTTLE"(
  "THROTTLE_TIME_ZONE" Number,
  "THROTTLE_STEP_NAME" Varchar2(128 CHAR) NOT NULL,
  "THROTTLE_LIMIT" Number,
  "LAST_UPDATED" Timestamp(6) DEFAULT SYSDATE NOT NULL
)
/

-- Table SCHEMA_VERSION

CREATE TABLE "SCHEMA_VERSION"(
  "SCHEMA_VERSION" Number NOT NULL,
  "COMMENTS" Varchar2(4000 ) NOT NULL,
  "CHANGE_DATE" Timestamp(3) DEFAULT sysdate NOT NULL
)
/

INSERT INTO EBOOK_CONFIG.SCHEMA_VERSION (SCHEMA_VERSION, COMMENTS, CHANGE_DATE)
VALUES (1.0, 'Initial model created.', TO_DATE('04/02/2012', 'MM/DD/YYYY'));

COMMIT;

-- Create procedures section -------------------------------------------------

CREATE OR REPLACE PROCEDURE "EBOOK_CONFIG"."GRANT_PRIVILEGES"
AS
 V_OWNER  VARCHAR2(30);
 SQL_STMT VARCHAR2(2000);

 CURSOR GET_TABLE_NAMES IS
    SELECT T.TABLE_NAME
    FROM USER_TABLES T;
 
  GET_TBL GET_TABLE_NAMES%ROWTYPE;
    
 CURSOR GET_OBJ_NAMES IS
    SELECT OBJ.OBJECT_NAME
    FROM USER_OBJECTS OBJ
    WHERE OBJ.OBJECT_TYPE = 'PROCEDURE' OR OBJ.OBJECT_TYPE = 'FUNCTION';
  
  GET_OBJ GET_OBJ_NAMES%ROWTYPE;
  
  CURSOR GET_SEQ_NAMES IS
     SELECT SEQUENCE_NAME 
     FROM USER_SEQUENCES;
     
  GET_SEQ GET_SEQ_NAMES%ROWTYPE;

BEGIN
    SELECT USERNAME
    INTO V_OWNER
    FROM USER_USERS;
    
    OPEN GET_TABLE_NAMES;
        LOOP
             FETCH GET_TABLE_NAMES INTO GET_TBL;
             EXIT WHEN GET_TABLE_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_READ';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
             SQL_STMT := 'GRANT SELECT, INSERT, DELETE, UPDATE ON  ' || V_OWNER || '.' || GET_TBL.TABLE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_TABLE_NAMES;
    
    OPEN GET_OBJ_NAMES;
        LOOP
             FETCH GET_OBJ_NAMES INTO GET_OBJ;
             EXIT WHEN GET_OBJ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT EXECUTE ON  ' || V_OWNER || '.' || GET_OBJ.OBJECT_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_OBJ_NAMES;
    
    OPEN GET_SEQ_NAMES;
        LOOP
             FETCH GET_SEQ_NAMES INTO GET_SEQ;
             EXIT WHEN GET_SEQ_NAMES%NOTFOUND;
             SQL_STMT := 'GRANT SELECT ON  ' || V_OWNER || '.' || GET_SEQ.SEQUENCE_NAME || ' TO EBOOK_USER';
             DBMS_OUTPUT.PUT_LINE(SQL_STMT);
             EXECUTE IMMEDIATE SQL_STMT;
        END LOOP;
    CLOSE GET_SEQ_NAMES;

END GRANT_PRIVILEGES;
/




EXEC EBOOK_CONFIG.GRANT_PRIVILEGES;
