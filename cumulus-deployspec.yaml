---
# Defaults section is optional.  Items in both Defaults and a specific environment are overridden by the value
#  in the environment.
Defaults:

  DeployerVersion: "1" # Required: Specifies the version of the deployer to use.
  AssetId: 206296 # Optional: The asset ID associated with the service.  Defaults to the same AssetId as the Deployment Engine'sf
  DeployerType: blue_green_deployer  # Required: Specifies the deployer to be used.
  ServiceName: TEN-Acct-Id  # FIXME  Same as your GroupName.  Outside this dojo, this would be the actual service name you are deploying.

  # Optional: If not specified, it is Autogenerated from the above parameters.
  # DeploymentRole: arn:aws:iam::307097860667:role/human-role/a205930-PowerUser2

  DeployerParameters:  # Required: Parameters specific to the blue/green deployer.
    Service:
      EnvironmentType: DEVELOPMENT # Mandatory.
      ResourceOwner: firstname.lastname@tr.com  # Mandatory FIXME Your email
      # Version: "1" # Optional: Defaults to "1".  Can be modified by the bake stage since the version is known there.

    # Optional.
    # Those items related to approving the traffic release to customers.
    # If SNS or SQS are not provided, the only way to approve/deny is by using
    # the Cumulus CLI.
    ApprovalNotifications:
      ApprovalSNSArns:  # Optional. SNS topic to send Release Approval request
        - "arn:aws:sns:eu-west-1:307097860667:a206296-TEN-Acct-Id-bluegreen-resource-cleanup-topic"

      # Optional. Additional things you want in your release approval request.
      ApprovalNotificationData:
        Thing1: Something I want to know
        Thing2: Maybe something important

    Cleanup:
      DenyDeploymentMinutes: 0 # Optional: Minutes to keep deployments that were denied before release.  Defaults to GenericFailureMinutes.
      FailedTrafficShiftMinutes: 30 # Optional: Minutes to keep deployments that failed during traffic shift.  Defaults to GenericFailureMinutes.
      OldVersionMinutes: 600 # Optional: Minutes to keep old versions of deployment after they are replaced.  Defaults to GenericFailureMinutes.

      GenericFailureMintues: 20 # Optional: Minutes to keep deployments for a reason that isn't one of the above. Defaults to 60 minutes.

    Stack:
      Template: # Mandatory:
        # Use these to use a built-in template
        # Name: ecs
        # Version: 1

        # If your cfn template is in S3, it can be specified as below.
        # Url: "s3://a206296-tr-tax-prof1-cicd-nonprod-eu-west-1-dojo/templates/fargate_service.yaml"

        # Use these to do the same thing as `Url` above.
        Bucket: a206296-tr-tax-prof1-cicd-nonprod-eu-west-1-dojo
        Key: templates/fargate_service.yaml

      Parameters: # Parameters to pass to the CloudFormation stack provisioning your versioned service.
        ServiceName: TEN-Acct-Id  # FIXME  Same as your GroupName
        ContainerPort: 8080
        ContainerCpu: 256
        ContainerMemory: 512

    # Optional. Determines how automated testing works.
    Testing:
      Automated: True  # Whether automated testing is enabled.
      SnsArns: "arn:aws:sns:eu-west-1:307097860667:a206296-TEN-Acct-Id-bluegreen-resource-cleanup-topic"  # The SNS topic to notify when testing begins.
      CodeBuildArn: "arn:aws:codebuild:eu-west-1:307097860667:project/a206296-TEN-Acct-Id-dojo-tester"  # The CodeBuild project that will run automated tests.

    Routing:
      TestingEndpoint: "http://www.yourendpoint.com" # Required: Used in testing alert message to indicate what URL to test on.
      TargetGroupRouter:
        TargetRulePriority: 20000  # The priority you want your application to run at when it is live to customers.
        GreenRulePriority: 19999  # The priority the test version of the app should be deployed to.  Should be higher in priority (a lower number) than the TargetRulePriority
        BlueRulePriority: 19998 # Optional. The priority that the old version of the app should be accessible from. Should be higher in priority than the TargetRulePriority.
        Stack:
          Template: # Mandatory:  One of below must be specified.
            # Use these to use a built-in template
            # Name: target-group
            # Version: 1

            # If your cfn template is in S3, it can be specified as below.
            # Url: "s3://a205930-cloud-scrum/ben-dojo/target_group.yaml"

            # Use these to do the same thing as `Url` above.
            Bucket: a206296-tr-tax-prof1-cicd-nonprod-eu-west-1-dojo
            Key: templates/target_group.yaml
          Parameters: # Parameters to pass to the CloudFormation stack provisioning your target group and listener rule.
            RoutePathPatterns: /,/add,/subtract,/multiply
            HealthCheckPath: /
            TargetGroupPort: 8080

      Shifting: # This defines the details of the releasing (shifting) process.
        Type: linear

        # These variable determine how fast the traffic is shifted.
        # The variables below mean "Shift 10% of the traffic over to live every 20 seconds"
        # If ShiftPercentage was 100, then this would be an instant release to customers (also known as a binary flip)
        # If this is a first deployment, then there is no linear shift since there is nothing to shift from.
        ShiftPercentage: 10  # How much traffic to shift at a time
        WaitTimeSeconds: 20  # How long to wait in between shifts

        # This sets a 'stickiness' to the live rule.
        # This means that if a client hits the new or old target group during the release,
        # any subsequent hits from the client in the next <DurationSeconds> seconds will go to the same target group.
        TargetGroupStickiness:
          Enabled: False  # We will turn this off so that it's easier to experience the linear shift.
          DurationSeconds: 10

        # This is the ID of a Datadog alarm that you can use to monitor your deployments.
        # If the Datadog alarm is triggered during the release process, then the deployment will be rolled back.
        # Configuring an alarm is outside the scope of this example app.
        # Alarm: "12345678"

      # If an Alarm was specified, this is where the Datadog API and Application keys would go.
      # DatadogApiKeyArn: arn:aws:secretsmanager:eu-west-1:307097860667:secret:a206296-datadog-api-key
      # DatadogApplicationKeyArn: arn:aws:secretsmanager:eu-west-1:307097860667:secret:a206296-datadog-app-key

    # If you wanted to skip the approval process, you could set this to True
    # AutoApprove: True

# # Uncomment this block if you want to use the servicenow integration
# # https://github.com/tr/cumulus_cicd-servicenow-chg-automation-example
# dev-ScriptOnly:
#   ScriptOnlyLambdas:
#     - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-dev-create-change
#       InputLocation: hooks/snow.json
# qa-ScriptOnly:
#   ScriptOnlyLambdas:
#     - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-qa-create-change
#       InputLocation: hooks/snow.json

dev:
  AccountId: "773476038677" # Recommended: The account to deploy to.  Defaults to the account the Deployment Engine is in.
  AccountRegion: eu-west-1  # Recommended: The region to deploy to.  Defaults to the region the Deployment Engine is in.

  # # Uncomment this block if you want to use the servicenow integration
  # # https://github.com/tr/cumulus_cicd-servicenow-chg-automation-example
  # PreDeployLambdas:
  #   - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-dev-prepare-for-deployment
  # PostDeployLambdas:
  #   - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-dev-post-deploy

  DeployerParameters:
    # Uncomment this block if you want to use the servicenow integration
    # https://github.com/tr/cumulus_cicd-servicenow-chg-automation-example
    ApprovalNotifications:
      ApprovalSQSUrl: https://sqs.eu-west-1.amazonaws.com/307097860667/a206296-dojo-TEN-Acct-Id-dev-release-approval

    Stack:

      Parameters: # Environment specific stack parameters
        ImageUrl: "Filled in by BakeSpec"
        DesiredCount: 1
        ClusterName: a206296-dojo-TEN-Acct-Id-dev
        SecurityGroup: sg-0ab3d3d439ea5f79d
        ExecutionRoleArn: arn:aws:iam::773476038677:role/a206296-TEN-Acct-Id-ems-dojo-dev-ECSTaskExecutionRole-18663VC6E53DM
    Testing:
      Parameters:
        APPLICATION_DNS: internal-a206296-dojo-TEN-Acct-Id-dev-1678614246.eu-west-1.elb.amazonaws.com
    Routing:
      TargetGroupRouter:
        ListenerARN: arn:aws:elasticloadbalancing:eu-west-1:773476038677:listener/app/a206296-dojo-TEN-Acct-Id-dev/45e481811e90a7dd/1a2a71b2938ee4b5

qa:
  AccountId: "773476038677" # Recommended: The account to deploy to.  Defaults to the account the Deployment Engine is in.
  AccountRegion: eu-west-1  # Recommended: The region to deploy to.  Defaults to the region the Deployment Engine is in.

  # # Uncomment this block if you want to use the servicenow integration
  # # https://github.com/tr/cumulus_cicd-servicenow-chg-automation-example
  # PreDeployLambdas:
  #   - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-qa-prepare-for-deployment
  # PostDeployLambdas:
  #   - LambdaArn: arn:aws:lambda:eu-west-1:307097860667:function:a206296-u016226-servicenow-qa-post-deploy

  DeployerParameters:
    # Uncomment this block if you want to use the servicenow integration
    # https://github.com/tr/cumulus_cicd-servicenow-chg-automation-example
    ApprovalNotifications:
      ApprovalSQSUrl: https://sqs.eu-west-1.amazonaws.com/307097860667/a206296-dojo-TEN-Acct-Id-qa-release-approval
    Stack:
      Parameters: # Environment specific stack parameters
        ImageUrl: "Filled in by BakeSpec"
        DesiredCount: 1
        ClusterName: a206296-dojo-TEN-Acct-Id-qa
        SecurityGroup: sg-0553ff0c3ab74483d
        ExecutionRoleArn: arn:aws:iam::773476038677:role/a206296-TEN-Acct-Id-ems-dojo-qa-ECSTaskExecutionRole-1SLQBA85CSAIQ
    Testing:
      Parameters:
        APPLICATION_DNS: internal-a206296-dojo-TEN-Acct-Id-qa-943433301.eu-west-1.elb.amazonaws.com
    Routing:
      TargetGroupRouter:
        ListenerARN: arn:aws:elasticloadbalancing:eu-west-1:773476038677:listener/app/a206296-dojo-TEN-Acct-Id-qa/845f94d5afa3b385/eff3616bd245e56e
      # We can set the shifting to be faster or slower on other environments.
      Shifting:
        ShiftPercentage: 5
        WaitTimeSeconds: 30
