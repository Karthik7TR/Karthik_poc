version: 0.2

phases:
  install:
    runtime-versions:
      docker: 18

  pre_build:
    commands:
      # Get ecr credentials and login
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region ${ECR_REGION})

  build:
    commands:

      # Build image
      - echo "Building the Docker image..."
      - IMAGE_NAME=a${ASSET_ID}-techops-repo
      - HASH=`date +%s`
      - IMAGE_URI="${ECR_ACCOUNT}.dkr.ecr.${ECR_REGION}.amazonaws.com/${IMAGE_NAME}:${HASH}"
      - echo "Pushing Image ${IMAGE_URI}"
      - docker build . --tag ${IMAGE_NAME}:latest
      - docker tag ${IMAGE_NAME}:latest ${IMAGE_URI} ;
      - docker push ${IMAGE_URI} ;
