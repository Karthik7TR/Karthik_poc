version: 0.2

phases:
  install:
    runtime-versions:
      docker: 18
      python: 3.8

  pre_build:
    commands:
      # Get ecr credentials and login
      - echo Logging in to Amazon ECR...
      - $(aws ecr get-login --no-include-email --region ${REGION} --registry-ids ${ACCOUNT_ID})
      - pip3 install boto3 docker pyyaml  # Requirements for helper script

  build:
    commands:
      # Build image
      - echo "Building the Docker image..."
      - IMAGE_NAME=a206296-TEN-Acct-Id-dojo-repo  # FIXME From output `ECRName` in a206296-${TEN-Acct-Id}-ems-dojo-dev-ecr-repository-ecrconfig stack in deployment account
      - HASH=`date +%s`
      - docker build . --tag ${IMAGE_NAME}:latest

  post_build:
    commands:
      # This Python script tags and pushes the images to the ECRs in the accounts and regions in the environments in your deployspec.
      # It also modifies the deployspec to put the right image URL in the given path in your deployspec environents.
      - |-
        python3 bake_helper.py --image ${IMAGE_NAME} --tag ${HASH} --param-path DeployerParameters.Stack.Parameters.ContainerImageUri

artifacts:
  files:
    - "**/*"
